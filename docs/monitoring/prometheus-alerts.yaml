# Reference PrometheusRule for OpenClaw operator alerts.
# The operator can auto-provision these via spec.observability.metrics.prometheusRule.enabled: true
# This file is a static reference for manual installation.
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: openclaw-operator-alerts
  labels:
    app.kubernetes.io/name: openclaw
    app.kubernetes.io/managed-by: openclaw-operator
spec:
  groups:
    - name: openclaw-operator
      rules:
        - alert: OpenClawReconcileErrors
          expr: |
            sum(rate(openclaw_reconcile_total{result="error"}[5m])) by (instance, namespace) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "OpenClaw instance {{ $labels.instance }} in {{ $labels.namespace }} has reconciliation errors."
            runbook_url: "https://openclaw.rocks/docs/runbooks/OpenClawReconcileErrors"

        - alert: OpenClawInstanceDegraded
          expr: |
            openclaw_instance_phase{phase=~"Failed|Degraded"} == 1
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "OpenClaw instance {{ $labels.instance }} in {{ $labels.namespace }} is in {{ $labels.phase }} phase."
            runbook_url: "https://openclaw.rocks/docs/runbooks/OpenClawInstanceDegraded"

        - alert: OpenClawSlowReconciliation
          expr: |
            histogram_quantile(0.99, sum(rate(openclaw_reconcile_duration_seconds_bucket[5m])) by (le, instance, namespace)) > 30
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "OpenClaw instance {{ $labels.instance }} p99 reconciliation duration exceeds 30s."
            runbook_url: "https://openclaw.rocks/docs/runbooks/OpenClawSlowReconciliation"

        - alert: OpenClawPodCrashLooping
          expr: |
            increase(kube_pod_container_status_restarts_total{container="openclaw"}[10m]) > 2
          for: 0m
          labels:
            severity: critical
          annotations:
            summary: "OpenClaw pod {{ $labels.pod }} is crash-looping (>2 restarts in 10m)."
            runbook_url: "https://openclaw.rocks/docs/runbooks/OpenClawPodCrashLooping"

        - alert: OpenClawPodOOMKilled
          expr: |
            kube_pod_container_status_last_terminated_reason{reason="OOMKilled",container="openclaw"} == 1
          for: 0m
          labels:
            severity: warning
          annotations:
            summary: "OpenClaw pod {{ $labels.pod }} was OOM killed. Consider increasing memory limits."
            runbook_url: "https://openclaw.rocks/docs/runbooks/OpenClawPodOOMKilled"

        - alert: OpenClawPVCNearlyFull
          expr: |
            (kubelet_volume_stats_used_bytes{persistentvolumeclaim=~"data-.*"} / kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~"data-.*"}) > 0.80
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PVC {{ $labels.persistentvolumeclaim }} is over 80% full."
            runbook_url: "https://openclaw.rocks/docs/runbooks/OpenClawPVCNearlyFull"

        - alert: OpenClawAutoUpdateRollback
          expr: |
            increase(openclaw_autoupdate_rollbacks_total[1h]) > 0
          for: 0m
          labels:
            severity: warning
          annotations:
            summary: "OpenClaw instance {{ $labels.instance }} auto-update rolled back in the last hour."
            runbook_url: "https://openclaw.rocks/docs/runbooks/OpenClawAutoUpdateRollback"
